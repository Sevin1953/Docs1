<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Виртуальная 3D картинная галерея</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Стабильная версия A-Frame без проблем с useLegacyLights -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: 'Segoe UI', sans-serif;
    }
    #infoBox {
      position: fixed;
      bottom: 1em;
      left: 1em;
      right: 1em;
      background: rgba(255, 255, 255, 0.97);
      color: #000;
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      display: none;
      max-width: 420px;
      z-index: 1000;
      font-size: 0.95em;
      line-height: 1.6;
      border: 1px solid #eee;
    }
    #closeBtn {
      float: right;
      cursor: pointer;
      color: #888;
      font-weight: bold;
      font-size: 1.3em;
      margin-left: 10px;
      user-select: none;
    }
    #closeBtn:hover {
      color: #000;
    }
    .info-title {
      font-size: 1.15em;
      font-weight: 600;
      margin-bottom: 6px;
      color: #1a1a1a;
    }
    .info-author {
      font-style: italic;
      color: #555;
      margin-bottom: 8px;
    }
    .info-desc {
      color: #333;
    }
  </style>
</head>
<body>

<!-- Информационное окно -->
<div id="infoBox">
  <span id="closeBtn">X</span>
  <div id="infoContent"></div>
</div>

<!-- Сцена A-Frame -->
<a-scene
  background="color: #f5f5f5"
  shadow="type: pcfsoft"
  fog="type: linear; color: #f0f0f0; near: 10; far: 20">

<!-- Освещение -->
  <a-entity light="type: ambient; intensity: 1.0"></a-entity>
  <a-entity light="type: directional; intensity: 1.2; castShadow: true" position="4 7 4"></a-entity>

  <!-- Пол и стены -->
  <a-box position="0 0 0" width="12" height="0.1" depth="12" color="#ffffff" shadow="receive: true"></a-box>
  <a-box position="0 3 -6" width="12" height="6" depth="0.1" color="#e8e8e8"></a-box>
  <a-box position="0 3 6" width="12" height="6" depth="0.1" color="#e8e8e8"></a-box>
  <a-box position="-6 3 0" width="0.1" height="6" depth="12" color="#e8e8e8"></a-box>
  <a-box position="6 3 0" width="0.1" height="6" depth="12" color="#e8e8e8"></a-box>

  <!-- Галерея -->
  <a-entity id="gallery"></a-entity>

  <!-- Камера -->
  <a-entity camera look-controls wasd-controls position="0 1.6 0" rotation="0 90 0">
    <a-entity cursor="rayOrigin: mouse; fuse: false"
              raycaster="objects: .clickable; far: 30"></a-entity>
  </a-entity>



</a-scene>

<script>
async function initGallery() {
  try {
    const [manifestRes, descRes] = await Promise.all([
      fetch('assets/manifest.json'),
      fetch('assets/descriptions.json')
    ]);

    if (!manifestRes.ok) throw new Error(`Не удалось загрузить manifest.json (${manifestRes.status})`);
    if (!descRes.ok) throw new Error(`Не удалось загрузить descriptions.json (${descRes.status})`);

    const manifest = await manifestRes.json();
    const desc = await descRes.json();
    const root = document.getElementById('gallery');
    const files = manifest.paintings || [];

    if (files.length === 0) throw new Error('В manifest.json нет картин (массив "paintings" пуст)');

    files.forEach((file, i) => {
      const angle = (i / files.length) * Math.PI * 2;
      const radius = 4.8;
      const x = radius * Math.cos(angle);
      const z = radius * Math.sin(angle);
      const rotY = -angle * 180 / Math.PI + 90;

      const info = desc[file.filename] || {
        title: 'Без названия',
        author: 'Неизвестный автор',
        year: '',
        description: 'Описание отсутствует'
      };

      const plane = document.createElement('a-plane');
      plane.setAttribute('src', `assets/${file.filename}`);
      plane.setAttribute('material', 'side: double;');
      plane.setAttribute('color', '#ffffff');
      plane.setAttribute('wireframe', false);
      plane.setAttribute('width', '1.8');
      plane.setAttribute('height', '1.2');
      plane.setAttribute('position', `${x} 1.6 ${z}`);
      plane.setAttribute('rotation', `0 ${rotY} 0`);
      plane.setAttribute('shadow', 'cast: true; receive: false');
      plane.classList.add('clickable');

      plane.dataset.title = info.title;
      plane.dataset.author = info.author;
      plane.dataset.year = info.year;
      plane.dataset.desc = info.description;

      plane.addEventListener('click', () => showInfo(plane));
      root.appendChild(plane);
    });

    console.log(`Галерея загружена: ${files.length} картин`);
  } catch (err) {
    console.error('Ошибка инициализации галереи:', err);
    alert('Ошибка загрузки галереи:\n' + err.message);
  }
}

function showInfo(el) {
  const box = document.getElementById('infoBox');
  const content = document.getElementById('infoContent');
  content.innerHTML = `
    <div class="info-title">${el.dataset.title}</div>
    <div class="info-author">${el.dataset.author} (${el.dataset.year})</div>
    <div class="info-desc">${el.dataset.desc}</div>
  `;
  box.style.display = 'block';
}

document.getElementById('closeBtn').onclick = () => {
  document.getElementById('infoBox').style.display = 'none';
};

initGallery();
</script>

</body>
</html>
